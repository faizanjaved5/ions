<!DOCTYPE html>
<html>
<head>
    <title>R2 Multipart Upload Test</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1e1e1e;
            color: #fff;
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success { background: #1e4620; border-left: 4px solid #4CAF50; }
        .error { background: #4a1e1e; border-left: 4px solid #f44336; }
        .info { background: #1e3a4a; border-left: 4px solid #2196F3; }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 10px 5px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 14px;
        }
        button:hover { background: #45a049; }
        #log {
            background: #000;
            padding: 15px;
            border-radius: 4px;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
        }
        .log-entry {
            margin: 5px 0;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <h1>üîç R2 Multipart Upload Diagnostic Tool</h1>
    
    <div class="test-result info">
        <strong>Purpose:</strong> Test if R2 Multipart Upload is properly loaded and configured
    </div>

    <h2>Step 1: Check if Scripts are Loaded</h2>
    <button onclick="testScriptsLoaded()">üîç Test Scripts</button>
    <div id="scriptsResult"></div>

    <h2>Step 2: Test File Size Detection</h2>
    <input type="file" id="fileInput" accept="video/*">
    <button onclick="testFileSizeDetection()">üìä Test File Size Detection</button>
    <div id="fileSizeResult"></div>

    <h2>Step 3: Test R2 Multipart Initialization</h2>
    <button onclick="testR2Initialization()">üöÄ Test R2 Multipart Init</button>
    <div id="r2InitResult"></div>

    <h2>Diagnostic Log</h2>
    <div id="log"></div>

    <script>
        const LARGE_FILE_THRESHOLD = 100 * 1024 * 1024; // 100MB

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            const emoji = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : 'üìù';
            entry.textContent = `${emoji} [${new Date().toLocaleTimeString()}] ${message}`;
            entry.style.color = type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : '#fff';
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function testScriptsLoaded() {
            const resultDiv = document.getElementById('scriptsResult');
            resultDiv.innerHTML = '';
            
            log('Testing if scripts are loaded...');

            const tests = [
                { name: 'R2MultipartUploader', check: typeof window.R2MultipartUploader !== 'undefined' },
                { name: 'ChunkedUploader', check: typeof window.ChunkedUploader !== 'undefined' },
                { name: 'processPlatformImport', check: typeof window.processPlatformImport !== 'undefined' },
                { name: 'showGoogleDrivePicker', check: typeof window.showGoogleDrivePicker !== 'undefined' },
                { name: 'EnhancedIONShare', check: typeof window.EnhancedIONShare !== 'undefined' }
            ];

            let allPassed = true;
            tests.forEach(test => {
                const result = document.createElement('div');
                result.className = `test-result ${test.check ? 'success' : 'error'}`;
                result.textContent = `${test.check ? '‚úÖ' : '‚ùå'} ${test.name}: ${test.check ? 'LOADED' : 'NOT LOADED'}`;
                resultDiv.appendChild(result);
                
                log(`${test.name}: ${test.check ? 'LOADED' : 'NOT LOADED'}`, test.check ? 'success' : 'error');
                
                if (!test.check) allPassed = false;
            });

            if (!allPassed) {
                const warning = document.createElement('div');
                warning.className = 'test-result error';
                warning.innerHTML = '<strong>‚ö†Ô∏è SOLUTION:</strong> Hard refresh browser (Ctrl+Shift+F5) or clear cache!';
                resultDiv.appendChild(warning);
                log('Some scripts not loaded - HARD REFRESH NEEDED!', 'error');
            } else {
                log('All scripts loaded successfully!', 'success');
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function testFileSizeDetection() {
            const fileInput = document.getElementById('fileInput');
            const resultDiv = document.getElementById('fileSizeResult');
            resultDiv.innerHTML = '';

            if (!fileInput.files || fileInput.files.length === 0) {
                resultDiv.innerHTML = '<div class="test-result error">‚ùå Please select a file first!</div>';
                log('No file selected', 'error');
                return;
            }

            const file = fileInput.files[0];
            log(`Selected file: ${file.name} (${file.size} bytes)`);

            const result = document.createElement('div');
            result.className = 'test-result info';
            result.innerHTML = `
                <strong>File Information:</strong><br>
                ‚Ä¢ Name: ${file.name}<br>
                ‚Ä¢ Size: ${formatFileSize(file.size)} (${file.size.toLocaleString()} bytes)<br>
                ‚Ä¢ Type: ${file.type}<br>
                ‚Ä¢ Threshold: ${formatFileSize(LARGE_FILE_THRESHOLD)} (${LARGE_FILE_THRESHOLD.toLocaleString()} bytes)
            `;
            resultDiv.appendChild(result);

            const shouldUseMultipart = file.size > LARGE_FILE_THRESHOLD;
            const decision = document.createElement('div');
            decision.className = `test-result ${shouldUseMultipart ? 'success' : 'info'}`;
            decision.innerHTML = `
                <strong>${shouldUseMultipart ? 'üöÄ R2 Multipart Upload' : 'üì§ Regular Upload'}</strong><br>
                ${shouldUseMultipart ? 
                    `File is LARGER than 100MB ‚Üí Will use R2 Multipart Upload` : 
                    `File is SMALLER than 100MB ‚Üí Will use regular upload`}
            `;
            resultDiv.appendChild(decision);

            log(`File size check: ${shouldUseMultipart ? 'R2 MULTIPART' : 'REGULAR'}`, shouldUseMultipart ? 'success' : 'info');
        }

        function testR2Initialization() {
            const resultDiv = document.getElementById('r2InitResult');
            resultDiv.innerHTML = '';

            log('Testing R2 Multipart initialization...');

            if (typeof window.R2MultipartUploader === 'undefined') {
                resultDiv.innerHTML = `
                    <div class="test-result error">
                        ‚ùå R2MultipartUploader NOT LOADED!<br>
                        <strong>Solution:</strong> Hard refresh (Ctrl+Shift+F5) or clear browser cache
                    </div>
                `;
                log('R2MultipartUploader not available!', 'error');
                return;
            }

            try {
                const uploader = new window.R2MultipartUploader({
                    partSize: 100 * 1024 * 1024,
                    maxConcurrentUploads: 3,
                    maxRetries: 3,
                    endpoint: './ionuploadermultipart2.php',
                    onProgress: (data) => console.log('Progress:', data),
                    onSuccess: (data) => console.log('Success:', data),
                    onError: (error) => console.error('Error:', error)
                });

                resultDiv.innerHTML = `
                    <div class="test-result success">
                        ‚úÖ R2MultipartUploader initialized successfully!<br>
                        ‚Ä¢ Part Size: ${formatFileSize(uploader.partSize)}<br>
                        ‚Ä¢ Max Concurrent: ${uploader.maxConcurrentUploads}<br>
                        ‚Ä¢ Max Retries: ${uploader.maxRetries}<br>
                        ‚Ä¢ Endpoint: ${uploader.endpoint}
                    </div>
                `;
                log('R2MultipartUploader initialized successfully!', 'success');
                log(`Endpoint: ${uploader.endpoint}`, 'success');
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="test-result error">
                        ‚ùå Failed to initialize R2MultipartUploader!<br>
                        Error: ${error.message}
                    </div>
                `;
                log(`Initialization failed: ${error.message}`, 'error');
            }
        }

        // Auto-run tests on load
        window.addEventListener('load', function() {
            log('=== R2 Multipart Diagnostic Tool Started ===');
            log('Ready to test!');
            
            // Auto-test scripts
            setTimeout(() => {
                testScriptsLoaded();
            }, 500);
        });
    </script>
</body>
</html>

